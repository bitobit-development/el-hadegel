// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Knesset Member model
model MK {
  id              Int               @id @default(autoincrement())
  mkId            Int               @unique // Official Knesset ID
  nameHe          String            // Hebrew name
  faction         String            // Party/Faction in Hebrew
  photoUrl        String?           // Profile photo URL
  profileUrl      String            // Link to official Knesset profile
  phone           String?           // Contact phone number(s)
  email           String?           // Contact email
  currentPosition Position          @default(NEUTRAL)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  positionHistory    PositionHistory[]
  tweets             Tweet[]
  statusInfo         MKStatusInfo[]
  historicalComments HistoricalComment[]
  newsPosts          NewsPost[]
}

// Position history tracking
model PositionHistory {
  id        Int      @id @default(autoincrement())
  mkId      Int
  mk        MK       @relation(fields: [mkId], references: [id], onDelete: Cascade)
  position  Position
  notes     String?  // Optional admin notes
  changedBy String   // Admin email
  changedAt DateTime @default(now())
}

// Admin users
model Admin {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String   // Hashed with bcrypt
  name      String
  createdAt DateTime @default(now())

  lawComments  LawComment[]
}

// Position enum
enum Position {
  SUPPORT  // Green - תומך
  NEUTRAL  // Orange - ניטרלי
  AGAINST  // Red - מתנגד
}

// Social media posts/statements from Knesset members
model Tweet {
  id             Int      @id @default(autoincrement())
  mkId           Int
  content        String   // Tweet/statement content
  sourceUrl      String?  // Link to original post
  sourcePlatform String   // e.g., "Twitter", "Facebook", "News", "Knesset Website"
  postedAt       DateTime // When the post was originally published
  createdAt      DateTime @default(now())

  mk MK @relation(fields: [mkId], references: [id], onDelete: Cascade)

  // NewsPost Linking (reverse relation)
  newsPost NewsPost? @relation("NewsPostToTweet")

  @@index([mkId])
  @@index([postedAt])
}

// API keys for external integrations
model ApiKey {
  id         Int       @id @default(autoincrement())
  name       String    // Descriptive name (e.g., "Tweet Scraper Bot")
  keyHash    String    @unique // bcrypt hash of the API key
  isActive   Boolean   @default(true)
  lastUsedAt DateTime? // Last time this key was used
  createdAt  DateTime  @default(now())
  createdBy  String    // Admin email who created it

  @@index([keyHash])
}

// Status information entries for MKs (development-only feature)
model MKStatusInfo {
  id        Int      @id @default(autoincrement())
  mkId      Int
  mk        MK       @relation(fields: [mkId], references: [id], onDelete: Cascade)
  content   String   // Status info content (max 2000 characters)
  createdAt DateTime @default(now())
  createdBy String   // Admin email who created the entry

  @@index([mkId])
  @@index([createdAt])
}

// News posts with rich link previews
model NewsPost {
  id          Int      @id @default(autoincrement())
  content     String   // User-provided content (Hebrew)
  sourceUrl   String   // Original URL
  sourceName  String?  // Optional: "ידיעות אחרונות", "X (Twitter)"
  postedAt    DateTime // Publication time
  createdAt   DateTime @default(now())

  // Open Graph metadata (auto-scraped from sourceUrl)
  previewTitle       String?  // og:title
  previewImage       String?  // og:image URL
  previewDescription String?  // og:description
  previewSiteName    String?  // og:site_name

  // MK Linking (auto-detected from sourceUrl or content)
  mkId         Int?     // Optional link to MK
  mk           MK?      @relation(fields: [mkId], references: [id], onDelete: SetNull)
  syncedToTweet Boolean @default(false) // Track if synced to Tweet table
  tweetId      Int?     @unique // Link to created Tweet
  tweet        Tweet?   @relation("NewsPostToTweet", fields: [tweetId], references: [id], onDelete: SetNull)

  @@index([postedAt], name: "NewsPost_postedAt_idx")
  @@index([mkId], name: "NewsPost_mkId_idx")
  @@index([syncedToTweet], name: "NewsPost_syncedToTweet_idx")
  @@map("news_posts")
}

// Historical comments/statements from Knesset members about IDF recruitment law
model HistoricalComment {
  id                Int      @id @default(autoincrement())
  mkId              Int

  // Content fields
  content           String   @db.Text
  contentHash       String   // SHA-256 hash for exact duplicate detection
  normalizedContent String   @db.Text // Lowercased, whitespace-normalized

  // Source tracking
  sourceUrl         String
  sourcePlatform    String   // "News", "Twitter", "Facebook", "YouTube", "Knesset", "Interview"
  sourceType        String   // "Primary" (direct quote) or "Secondary" (reporting)
  sourceName        String?
  sourceCredibility Int      @default(5) // 1-10 scale

  // Classification
  topic             String   @default("IDF_RECRUITMENT")
  keywords          String[]
  isVerified        Boolean  @default(false)

  // Temporal
  commentDate       DateTime // When comment was made
  publishedAt       DateTime // When discovered/published
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Deduplication
  duplicateOf       Int?
  duplicateGroup    String?  // UUID for grouping similar content

  // Media
  imageUrl          String?
  videoUrl          String?
  additionalContext String?  @db.Text

  // Relations
  mk             MK                  @relation(fields: [mkId], references: [id], onDelete: Cascade)
  duplicates     HistoricalComment[] @relation("CommentDuplicates")
  primaryComment HistoricalComment?  @relation("CommentDuplicates", fields: [duplicateOf], references: [id])

  @@index([mkId])
  @@index([commentDate])
  @@index([contentHash])
  @@index([duplicateGroup])
  @@index([topic])
  @@index([isVerified])
  @@unique([contentHash, sourceUrl])
}

// Law Document - stores the IDF recruitment law document
model LawDocument {
  id          Int       @id @default(autoincrement())
  title       String    // "חוק יסוד: שירות חובה למען המדינה"
  description String?   @db.Text
  version     String    @default("1.0")
  isActive    Boolean   @default(true)
  publishedAt DateTime  @default(now())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  paragraphs  LawParagraph[]

  @@index([isActive])
  @@index([publishedAt])
}

// Law Paragraph - individual paragraphs/sections of the law document
model LawParagraph {
  id            Int          @id @default(autoincrement())
  documentId    Int
  orderIndex    Int          // Sequential order: 1, 2, 3... (for 60-70 paragraphs)
  sectionTitle  String?      // e.g., "מטרה", "הגדרות", "חובת השירות"
  content       String       @db.Text
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  document      LawDocument  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  comments      LawComment[]

  @@unique([documentId, orderIndex])
  @@index([documentId])
  @@index([orderIndex])
}

// Law Comment - visitor comments on paragraphs with moderation
model LawComment {
  id                  Int          @id @default(autoincrement())
  paragraphId         Int

  // Visitor Information (ALL REQUIRED)
  firstName           String
  lastName            String
  email               String
  phoneNumber         String

  // Comment Content
  commentContent      String       @db.Text
  suggestedEdit       String?      @db.Text  // Optional paragraph edit suggestion

  // Moderation
  status              CommentStatus @default(PENDING)
  moderatedBy         Int?
  moderatedAt         DateTime?
  moderationNote      String?      @db.Text

  // Metadata (for spam prevention)
  ipAddress           String?
  userAgent           String?      @db.Text
  submittedAt         DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  paragraph           LawParagraph @relation(fields: [paragraphId], references: [id], onDelete: Cascade)
  moderator           Admin?       @relation(fields: [moderatedBy], references: [id])

  @@index([paragraphId])
  @@index([status])
  @@index([submittedAt])
  @@index([email])
}

// Comment moderation status enum
enum CommentStatus {
  PENDING      // Default - awaiting moderation
  APPROVED     // Visible to public
  REJECTED     // Not visible, kept for admin review
  SPAM         // Flagged for pattern analysis
}

// Page View Tracking for Analytics
model PageView {
  id        Int      @id @default(autoincrement())
  path      String   // URL path visited (e.g., "/", "/admin", "/about")
  userAgent String?  // Browser/device info
  ipAddress String?  // Visitor IP (for unique visitor counting)
  referer   String?  // Where visitor came from
  timestamp DateTime @default(now())

  @@index([timestamp])
  @@index([path])
  @@index([ipAddress, timestamp])
}
