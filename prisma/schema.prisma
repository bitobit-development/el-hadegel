// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Knesset Member model
model MK {
  id              Int               @id @default(autoincrement())
  mkId            Int               @unique // Official Knesset ID
  nameHe          String            // Hebrew name
  faction         String            // Party/Faction in Hebrew
  photoUrl        String?           // Profile photo URL
  profileUrl      String            // Link to official Knesset profile
  phone           String?           // Contact phone number(s)
  email           String?           // Contact email
  currentPosition Position          @default(NEUTRAL)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  positionHistory PositionHistory[]
  tweets          Tweet[]
  statusInfo      MKStatusInfo[]
}

// Position history tracking
model PositionHistory {
  id        Int      @id @default(autoincrement())
  mkId      Int
  mk        MK       @relation(fields: [mkId], references: [id], onDelete: Cascade)
  position  Position
  notes     String?  // Optional admin notes
  changedBy String   // Admin email
  changedAt DateTime @default(now())
}

// Admin users
model Admin {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String   // Hashed with bcrypt
  name      String
  createdAt DateTime @default(now())
}

// Position enum
enum Position {
  SUPPORT  // Green - תומך
  NEUTRAL  // Orange - ניטרלי
  AGAINST  // Red - מתנגד
}

// Social media posts/statements from Knesset members
model Tweet {
  id             Int      @id @default(autoincrement())
  mkId           Int
  content        String   // Tweet/statement content
  sourceUrl      String?  // Link to original post
  sourcePlatform String   // e.g., "Twitter", "Facebook", "News", "Knesset Website"
  postedAt       DateTime // When the post was originally published
  createdAt      DateTime @default(now())

  mk MK @relation(fields: [mkId], references: [id], onDelete: Cascade)

  @@index([mkId])
  @@index([postedAt])
}

// API keys for external integrations
model ApiKey {
  id         Int       @id @default(autoincrement())
  name       String    // Descriptive name (e.g., "Tweet Scraper Bot")
  keyHash    String    @unique // bcrypt hash of the API key
  isActive   Boolean   @default(true)
  lastUsedAt DateTime? // Last time this key was used
  createdAt  DateTime  @default(now())
  createdBy  String    // Admin email who created it

  @@index([keyHash])
}

// Status information entries for MKs (development-only feature)
model MKStatusInfo {
  id        Int      @id @default(autoincrement())
  mkId      Int
  mk        MK       @relation(fields: [mkId], references: [id], onDelete: Cascade)
  content   String   // Status info content (max 2000 characters)
  createdAt DateTime @default(now())
  createdBy String   // Admin email who created the entry

  @@index([mkId])
  @@index([createdAt])
}

// News posts with rich link previews
model NewsPost {
  id          Int      @id @default(autoincrement())
  content     String   // User-provided content (Hebrew)
  sourceUrl   String   // Original URL
  sourceName  String?  // Optional: "ידיעות אחרונות", "X (Twitter)"
  postedAt    DateTime // Publication time
  createdAt   DateTime @default(now())

  // Open Graph metadata (auto-scraped from sourceUrl)
  previewTitle       String?  // og:title
  previewImage       String?  // og:image URL
  previewDescription String?  // og:description
  previewSiteName    String?  // og:site_name

  @@index([postedAt], name: "NewsPost_postedAt_idx")
  @@map("news_posts")
}
